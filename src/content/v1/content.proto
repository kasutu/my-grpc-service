// Copyright (c) Localize Technologies, Inc. All rights reserved.

// Used in communication with hydrogen nodes for content synchronization and control
// Connection is long lived and bidirectional

syntax = "proto3";

package content.v1;

service ContentService {
  // Flutter calls this once to subscribe to content updates
  rpc Subscribe(SubscribeRequest) returns (stream ContentPackage);
  
  // Unary call for acknowledgments (simpler than bidirectional)
  rpc Acknowledge(AcknowledgeRequest) returns (AcknowledgeResponse);
}

message SubscribeRequest {
  string device_id = 1;
  string last_received_delivery_id = 2; // For resume/reconnect
}

message ContentPackage {
  string delivery_id = 1;
  Content content = 2;
  repeated Media media = 3;
  bool requires_ack = 4; // If true, client must acknowledge
}

// Request to acknowledge content delivery
message AcknowledgeRequest {
  string device_id = 1;
  string delivery_id = 2;
  AcknowledgeStatus status = 3;
  string message = 4; // Human-readable status or error details
  
  // Structured progress (optional, for detailed reporting)
  ContentProgress progress = 5;
}

// Status of content acknowledgment
enum AcknowledgeStatus {
  ACKNOWLEDGE_STATUS_UNSPECIFIED = 0;
  ACKNOWLEDGE_STATUS_RECEIVED = 1;        // Package received, processing started
  ACKNOWLEDGE_STATUS_IN_PROGRESS = 2;     // Downloading/verifying media
  ACKNOWLEDGE_STATUS_COMPLETED = 3;       // All media processed successfully
  ACKNOWLEDGE_STATUS_PARTIAL = 4;         // Some media succeeded, some failed
  ACKNOWLEDGE_STATUS_FAILED = 5;          // Complete failure
}

// Detailed content processing progress
message ContentProgress {
  float percent_complete = 1;           // 0.0 to 100.0
  uint32 total_media_count = 2;
  uint32 completed_media_count = 3;
  uint32 failed_media_count = 4;
  repeated MediaStatus media_status = 5; // Per-media details
}

// Status of individual media file
message MediaStatus {
  string media_id = 1;
  MediaState state = 2;
  string error_code = 3;    // Machine-readable: "DOWNLOAD_FAILED", "CHECKSUM_MISMATCH"
  string error_message = 4; // Human-readable details
}

enum MediaState {
  MEDIA_STATE_UNSPECIFIED = 0;
  MEDIA_STATE_PENDING = 1;      // Waiting to download
  MEDIA_STATE_DOWNLOADING = 2;  // In progress
  MEDIA_STATE_DOWNLOADED = 3;   // File on disk, verifying
  MEDIA_STATE_VERIFIED = 4;     // Checksum verified
  MEDIA_STATE_FAILED = 5;       // Download or verification failed
}

message AcknowledgeResponse {
  bool accepted = 1;
  uint32 retry_after_seconds = 2; // If server wants client to backoff
}

// Types

message Content {
  int64 id = 1;
  string hmac_signature = 2;
  repeated TimeSlot time_slots = 3;
  MediaRef fallback_media_ref = 4;
  string created_at = 5;
}

message TimeSlot {
  string id = 1;
  string start_window = 2;
  string end_window = 3;
  repeated Campaign campaigns = 4;
}

message Campaign {
  string id = 1;
  int32 index = 2;
  string media_id = 3;
}

message MediaRef {
  string media_id = 1;
}

message Media {
  string id = 1;
  string checksum = 2;
  string url = 3;
}
